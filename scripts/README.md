This directory is used for running UQ analysis on different PEM configurations and experimental data.

## Predictive engineering models (PEM)

We define a "PEM" as a set of coupled component models that predicts global performance metrics and quantities of interest (QoIs), such as thrust, ion velocity, and efficiency, as a function of global inputs, such as discharge voltage, mass flow rate, and background chamber pressure.

We currently define two PEM configurations:

- **PEM test** - a temporary configuration for rapid iteration testing of variables, models, etc.
- **PEM v0** - a purely feedforward coupling between a semi-empirical cathode model, a 1d fluid thruster model, and a semi-empirical plume model ([Eckels et al. 2024](https://rdcu.be/dVmim)).
- **PEM v1** - An improved version of the above, with a better parameterization and revamped inference procedure.

See the corresponding directories for config files and analysis scripts.

A PEM must define the sets of parameters and ranges over which it seeks to be applicable. Any significant change to the parameters, underlying models, or the addition of new models or parameters would warrant a new "pem_vXX" directory for analysis.
The underlying models themselves (rather than the specific parameters or configurations) are maintained in the `src/hallmd` Python package by convention. The `hallmd` package also maintains devices, experimental data, and utility functions for each.

## Config files
We configure parameter estimation and surrogate modeling workflows using YAML files designed to interface with the [`amisc`](https://github.com/eckelsjd/amisc) multidisciplinary modeling package.
In these files, the user declares information about the thruster they're modeling and specifies any or all parameters they may want to vary.
Example config files for the SPT-100 Hall thruster can be found in the **PEM v0** and **PEM v1** folders.

## Running scripts
There are a few ways to run these scripts.
First, you need to install the script dependencies.
This can be done by running
```
pdm install -G scripts
```

Next, you will need to install a version of HallThruster.jl that matches the one called for in your config file.
This can be done using

```
pdm run scripts/install_hallthruster.py --julia-version=X.XX --hallthruster-version=X.XX.X
```

This script will also install `julia`, if not already present on the user's system
Run `pdm run scripts/install_hallthruster.py --help` to see other options.
Alternatively, if using the `mcmc_run.py` script, this will be done automatically upon loading the config file.

Each script can then be run using `pdm run <script name> <args>`.
See the help for each script to learn more.

## Script descriptions
There are a few general scripts that can be used for any PEM configuration:

### Environment setup
Installs `pdm` and the `hallmd` package. Also installs Julia and `HallThruster.jl`.
```shell
source setup_env.sh --hallthruster-version=0.18.3 --julia-version=1.10
```

### Train a surrogate
Loads a surrogate configuration from file, generates compression and test set data, trains a surrogate, and plots diagnostics.
```shell
./train.sh pem_v0/pem_v0_SPT-100.yml --compression_samples=100 --test_samples=100 --max_iter=100 --executor=process
```

### Run MCMC
The script `mcmc_run.py` will run Markov Chain Monte Carlo for a provided thruster-cathode-plume system and list of datasets.

Requires a valid YAML config file specifying the system.
The outputs are written to a folder called amisc_{TIMESTAMP}/mcmc if no output directory is specified.
That folder in turn contains folders (numbered 000000 - num_samples) that hold the model outputs for each sample generated during MCMC.
Additionally, each sample, its log-pdf, and whether it was accepted are written to a file called mcmc.csv in the main mcmc directory.

For usage details and a full list of options, run `pdm run scripts/run_mcmc.py --help`

### Analyze MCMC results
This script is used to analyze results generated by `mcmc_run.py`.
Requires a base_directory containing an `mcmc` subdirectory with MCMC results.
Generates several types of plots and analysis in the base directory / `mcmc_analysis`

#### Standard MCMC analyses
- Traces for each parameter
- Corner plot (if sufficient samples)

#### Prediction plots with 50 and 90% credible intervals
- Ion velocity across pressures
- Ion current density across pressures
- Thrust vs pressure
- Discharge current vs pressure
- Cathode coupling voltage vs pressure

#### Restarts and others
- MAP, mean, median, final parameters
- Empirical covariance

For usage details and a full list of options , run 'pdm run scripts/mcmc_analysis.py --help'

#### Generate plots for publication
The `pemv1_make_plots.py` script generates additional plots for publication, particularly plots that compare multiple MCMC runs to each other.

## PEM analysis procedure
For a new PEM configuration, follow this procedure for analysis:

1. Define a single `.yml` configuration file that specifies all models, parameters, configurations, etc. The format of this file follows the [`amisc` interface](https://eckelsjd.github.io/amisc/guides/config_file/). See also the config file for [PEM v0](pem_v0/pem_v0_SPT-100.yml) for an example.
1. Generate compression data for field quantities and a random test set for evaluating surrogate performance. See the [`gen_data.py`](gen_data.py) script.
1. Train a surrogate to approximate the model. See the [`fit_surr.py`](fit_surr.py) script.
1. Evaluate the performance of the surrogate. For example, you can [plot 1d slices](plot_slice.py) over the inputs and compare to the true model. Generally, < 10\% error is advisable before moving forward.
1. For convenience, `gen_data`, `fit_surr`, and `plot_slice` are all combined into one step using [`train.sh`](train.sh)).
1. Calibrate the model parameters to fit experimental data using the surrogate as a cheap approximation. See the [MCMC calibration](pem_v0/mcmc.py) of PEM v0 or the updated version for [PEM v1 and beyond](mcmc_run.py).
1. Run any other desired UQ analyses (Monte Carlo, Sobol' sensitivity analysis, etc.). The [PEM v0 directory](pem_v0) again provides a few examples.

In general, anytime _anything_ changes about the models (including parameter ranges, values, configurations, or general computations), then a new surrogate _must_ be built, including new compression data if applicable and a new test set. Note that individual component models can be modified and retrained independently of other components.

Analysis scripts that are uniquely tailored to a specific PEM configuration (i.e. Monte Carlo, MCMC, etc.) should be maintained in the corresponding directories.
